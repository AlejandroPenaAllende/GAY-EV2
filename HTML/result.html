<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hola</title>
</head>
<body>
    <h1 id="mensaje">Procesando pago...</h1>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabase = createClient('https://hmqxyjsnspztoymjyvll.supabase.co', 'your_public_key');

        const params = new URLSearchParams(window.location.search);
        const status = params.get('status');
        const token = params.get('token_ws');

        const mensaje = document.getElementById('mensaje');

        if (status === 'success') {
        mensaje.textContent = '✅ ¡Pago exitoso!';

        const carrito = JSON.parse(sessionStorage.getItem('carritoParaDescontar')) || [];

        for (const item of carrito) {
            await supabase
            .from('product2')
            .update({ stock: supabase.raw(`stock - ${item.cantidad}`) })
            .eq('code', item.codigo);
        }

        sessionStorage.removeItem('carritoParaDescontar');
        localStorage.removeItem('carrito');
        } else {
        mensaje.textContent = '❌ Pago fallido.';
        }
    </script>
</body>

</html>
